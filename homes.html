<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Find Your Home - Bonita Springs & Estero</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <style>
    :root {
      --primary: #1a2a3a;
      --accent: #4bc6f6;
      --bg: #f8f9fa;
      --text: #333;
      --white: #ffffff;
      --header-bg: rgba(20, 20, 20, 0.9);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }

    /* --- Header Styles (Ported from homepage.html) --- */
    #top-bar {
      position: fixed;
      top: 40px !important;
      /* Standardized offset */
      left: 50% !important;
      transform: translateX(-50%) !important;
      width: 95% !important;
      max-width: 1400px !important;
      background: var(--header-bg) !important;
      border-radius: 50px !important;
      padding: 10px 20px !important;
      z-index: 10000 !important;
      /* High Z-Index to beat Elementor */
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3) !important;
      display: flex !important;
      align-items: center !important;
      justify-content: space-between !important;
      backdrop-filter: blur(5px);
      margin: 0 !important;
      height: auto !important;
    }

    #bar-width {
      display: flex !important;
      align-items: center !important;
      width: 100% !important;
      justify-content: space-between !important;
    }

    .brand-wrapper {
      display: flex !important;
      align-items: center !important;
      gap: 15px !important;
      text-decoration: none !important;
      border: none !important;
    }

    /* Strict Logo Sizing to override Elementor/Theme defaults */
    .ber-logo {
      height: 50px !important;
      width: auto !important;
      max-width: 200px !important;
      min-width: 50px !important;
      object-fit: contain !important;
      margin: 0 !important;
      padding: 0 !important;
      border: none !important;
      box-shadow: none !important;
    }

    /* User Requirement: Overwrite Elementor Img styles */
    .elementor img {
      width: auto !important;
      height: auto !important;
      max-width: 100% !important;
      border: none !important;
      box-shadow: none !important;
    }

    .bser-title {
      color: var(--white) !important;
      font-family: 'Oswald', sans-serif !important;
      font-size: 1.5rem !important;
      font-weight: 700 !important;
      text-transform: uppercase !important;
      letter-spacing: 1px !important;
      line-height: 1 !important;
      margin: 0 !important;
    }

    .navbar-expand-md {
      display: flex !important;
      gap: 20px !important;
      list-style: none !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    .navbar-expand-md li {
      margin: 0 !important;
      padding: 0 !important;
    }

    .navbar-expand-md a {
      color: var(--white) !important;
      text-decoration: none !important;
      font-weight: 500 !important;
      font-size: 1rem !important;
      text-transform: uppercase !important;
      letter-spacing: 0.5px !important;
      transition: opacity 0.2s;
      border: none !important;
    }

    .navbar-expand-md a:hover {
      opacity: 0.8;
      text-decoration: none !important;
    }

    /* --- Layout --- */
    .filters-container {
      position: sticky;
      top: 100px;
      /* Below fixed header */
      z-index: 9;
      background: #fff;
      border-bottom: 1px solid #eee;
      padding: 10px 0;
    }

    .main-container {
      display: flex;
      height: calc(100vh - 220px);
      /* Adjust for header + filters */
      padding-top: 0;
      position: relative;
      z-index: 1;
    }

    .map-section {
      flex: 1;
      /* Left side by default flex order */
      position: relative;
      background: #e5e5e5;
      min-width: 0;
    }

    #map {
      height: 100%;
      width: 100%;
      z-index: 1;
    }

    /* Ensure Leaflet Images aren't messed up by global styles */
    .leaflet-pane img {
      max-width: none !important;
      width: auto !important;
      height: auto !important;
      box-shadow: none !important;
      border: none !important;
    }

    .listings-section {
      width: 450px;
      background: var(--bg);
      overflow-y: auto;
      border-left: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.05);
      z-index: 5;
      position: relative;
    }

    /* --- Filters --- */
    .filters-bar {
      padding: 15px;
      background: var(--white);
      border-bottom: 1px solid #eee;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .filter-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .filter-select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.9rem;
      background: #fff;
      flex: 1;
    }

    .search-btn {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 8px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .search-btn:hover {
      opacity: 0.9;
    }

    .results-count {
      font-size: 0.85rem;
      color: #666;
      margin-top: 5px;
    }

    /* --- Listing Cards --- */
    .listings-grid {
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .listing-card {
      background: var(--white);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: transform 0.2s;
      cursor: pointer;
      border: 1px solid transparent;
    }

    .listing-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.12);
    }

    .listing-card.active {
      border-color: var(--accent);
      background: #f0f9ff;
    }

    .card-img-wrapper {
      position: relative;
      padding-top: 60%;
      /* 3:2 Aspect Ratio */
      background: #eee;
      overflow: hidden;
    }

    .card-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100% !important;
      /* Force width for card images */
      height: 100% !important;
      object-fit: cover !important;
      border: none !important;
    }

    .price-badge {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .card-content {
      padding: 12px;
    }

    .card-address {
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-details {
      display: flex;
      gap: 12px;
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 8px;
    }

    .card-detail-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .card-meta {
      font-size: 0.8rem;
      color: #888;
      display: flex;
      justify-content: space-between;
    }

    /* --- Loading --- */
    .loading-overlay {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 20;
      backdrop-filter: blur(2px);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #ddd;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* --- Responsive --- */
    @media (max-width: 900px) {
      .navbar-expand-md {
        display: none !important;
      }

      /* Hide nav, use hamburger in future */
      .main-container {
        flex-direction: column-reverse;
        padding-top: 80px;
      }

      .listings-section {
        width: 100%;
        height: 50vh;
      }

      .map-section {
        height: 50vh;
      }

      #top-bar {
        width: 95% !important;
        top: 20px !important;
      }

      .ber-logo {
        height: 40px !important;
      }

      .bser-title {
        font-size: 1.2rem !important;
      }
    }
  </style>
</head>

<body>

  <!-- Header -->
  <div id="top-bar">
    <div id="bar-width">
      <a href="/" class="brand-wrapper">
        <img class="ber-logo"
          src="https://www.bonitaesterorealtors.com/wp-content/uploads/2021/08/Untitled-design-24.png"
          alt="Bonita Springs Estero Realtors">
        <div class="bser-title">BSER Lifestyles</div>
      </a>
      <ul class="navbar-expand-md">
        <li><a href="https://bonitaspringsesterolifestyles.com/communities/">Communities</a></li>
        <li><a href="http://bonitaspringsesterorealtorsfl.growthzoneapp.com/realtordirectory/Find">Find a REALTOR</a>
        </li>
        <li><a href="/homes.html">Property Search</a></li>
        <li><a href="https://bonitaspringsesterolifestyles.com/city-info/">City Info</a></li>
      </ul>
    </div>
  </div>

  <!-- Featured Carousel Section -->
  <div class="carousels-wrapper" id="carouselsWrapper" style="margin-top: 140px; display:none;">
    <!-- Just Listed Carousel -->
    <div class="carousel-container" id="featuredCarousel">
      <div class="carousel-header">
        <h2>Just Listed <span class="badge-new">New (7d)</span></h2>
      </div>
      <div class="carousel-track" id="carouselTrack"></div>
    </div>

    <!-- Status Changes Carousel -->
    <div class="carousel-container" id="statusCarousel" style="display:none; border-top: 1px solid #eee;">
      <div class="carousel-header">
        <h2>Price/Status Updates <span class="badge-update">Last 7d</span></h2>
      </div>
      <div class="carousel-track" id="statusTrack"></div>
    </div>
  </div>

  <!-- Search Bar (Moved Top) -->
  <div class="filters-container">
    <div class="filters-bar">
      <div class="filter-row">
        <!-- Type Toggle -->
        <div class="type-toggle"
          style="display:flex; background:#eee; border-radius:8px; padding:2px; margin-right:10px;">
          <button class="type-btn active" id="btnSale"
            style="border:none; background:#fff; padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:600; box-shadow:0 1px 3px rgba(0,0,0,0.1);">For
            Sale</button>
          <button class="type-btn" id="btnRent"
            style="border:none; background:transparent; padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:600; color:#666;">For
            Rent</button>
        </div>

        <select id="sortFilter" class="filter-select">
          <option value="dateDesc">Newest Listings</option>
          <option value="priceDesc">Price: High to Low</option>
          <option value="priceAsc">Price: Low to High</option>
        </select>
        <select id="cityFilter" class="filter-select">
          <option value="">All Cities</option>
          <option value="Bonita Springs">Bonita Springs</option>
          <option value="Estero">Estero</option>
          <option value="Naples">Naples</option>
          <option value="Fort Myers">Fort Myers</option>
        </select>
      </div>
      <!-- Expanded Filters -->
      <div class="filter-row">
        <input type="number" id="priceMin" class="filter-select" placeholder="Min Price" style="width: 100px;">
        <input type="number" id="priceMax" class="filter-select" placeholder="Max Price" style="width: 100px;">

        <select id="bedsFilter" class="filter-select">
          <option value="">Beds (Any)</option>
          <option value="2">2+</option>
          <option value="3">3+</option>
          <option value="4">4+</option>
        </select>

        <button class="search-btn" id="applyFiltersBtn">Apply</button>
        <button class="search-btn" style="background:#666;" id="clearFiltersBtn">Clear</button>
      </div>
      <div class="results-count" id="resultsCount" style="margin-left:auto; align-self:center;">Loading...</div>
    </div>
  </div>

  <div class="main-container">
    <!-- Map Section -->
    <div class="map-section">
      <div id="map"></div>
    </div>

    <!-- Listings Section -->
    <div class="listings-section">
      <div class="listings-grid" id="listingsGrid">
        <!-- Cards injected here -->
      </div>

      <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // --- Config ---
    const API_BASE = 'https://listingsworker.bonitaspringsrealtors.workers.dev';
    // Use OpenHouse worker for Media since ListingsWorker token is restricted
    const ODATA_MEDIA = `https://openhouseworker.bonitaspringsrealtors.workers.dev/api/v2/OData/bsaor/Media`;

    // State
    let map;
    let markers = [];
    let allListings = [];
    let mediaCache = new Map(); // Key -> URL (or Array of URLs now)
    let isRentalMode = false;   // Default to Sale

    const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      fetchListings();
      setupFilters();
      setupTypeToggle();
    });

    function setupTypeToggle() {
      const btnSale = document.getElementById('btnSale');
      const btnRent = document.getElementById('btnRent');

      btnSale.addEventListener('click', () => {
        if (isRentalMode) {
          isRentalMode = false;
          toggleBtns();
          fetchListings();
        }
      });

      btnRent.addEventListener('click', () => {
        if (!isRentalMode) {
          isRentalMode = true;
          toggleBtns();
          fetchListings();
        }
      });

      function toggleBtns() {
        if (isRentalMode) {
          btnRent.classList.add('active');
          btnRent.style.background = '#fff';
          btnRent.style.color = '#333';
          btnRent.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';

          btnSale.classList.remove('active');
          btnSale.style.background = 'transparent';
          btnSale.style.boxShadow = 'none';
          btnSale.style.color = '#666';
        } else {
          btnSale.classList.add('active');
          btnSale.style.background = '#fff';
          btnSale.style.color = '#333';
          btnSale.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';

          btnRent.classList.remove('active');
          btnRent.style.background = 'transparent';
          btnRent.style.boxShadow = 'none';
          btnRent.style.color = '#666';
        }
      }
    }

    async function fetchListings() {
      showLoading(true);
      try {
        // Base Filter
        let filter = "StandardStatus eq 'Active' and OriginatingSystemName eq 'Bonita Springs'";

        // Rental vs Sale Logic
        // Using PropertyType to distinguish
        if (isRentalMode) {
          filter += " and (PropertyType eq 'Residential Lease' or PropertyType eq 'Rental')";
        } else {
          filter += " and (PropertyType eq 'Residential' or PropertyType eq 'Land' or PropertyType eq 'Commercial')";
          filter += " and PropertyType ne 'Residential Lease' and PropertyType ne 'Rental'";
        }

        // Requesting basic fields first + StatusChangeTimestamp
        const select = "ListingKey,UnparsedAddress,City,ListPrice,BedroomsTotal,BathroomsTotalInteger,LivingArea,Coordinates,ListingContractDate,StatusChangeTimestamp";
        const top = 200;

        const params = new URLSearchParams();
        params.append('$filter', filter);
        params.append('$select', select);
        params.append('$top', top);
        params.append('$orderby', 'ListingContractDate desc');

        const url = `${API_BASE}/api/v2/OData/bsaor/Property?${params.toString()}`;

        const response = await fetch(url);

        if (!response.ok) {
          const txt = await response.text();
          throw new Error(`API Error ${response.status}: ${txt}`);
        }

        const data = await response.json();
        allListings = data.value || [];

        // 1. Start fetching media in background
        fetchMediaBatch(allListings);

        // 2. Render Carousels
        const now = new Date();
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(now.getDate() - 7);

        // A) Just Listed (Contract Date within last 7 days)
        const newListings = allListings.filter(x => x.ListingContractDate && new Date(x.ListingContractDate) >= oneWeekAgo);
        renderCarousel(newListings);

        // B) Status Changes (Status Change within last 7 days AND not just listed)
        const statusListings = allListings.filter(x => {
          if (!x.StatusChangeTimestamp) return false;
          const sc = new Date(x.StatusChangeTimestamp);
          const lc = x.ListingContractDate ? new Date(x.ListingContractDate) : null;
          if (sc < oneWeekAgo) return false;
          if (lc && (sc - lc) < 86400000) return false;
          return true;
        });
        renderStatusCarousel(statusListings);

        updateUI(allListings);

      } catch (err) {
        console.error(err);
        document.getElementById('listingsGrid').innerHTML = `
                    <div style="padding:20px; text-align:center; color: red;">
                        <strong>Error fetching data</strong><br>
                        ${err.message}<br><br>
                        <em>Please check console for details.</em>
                    </div>`;
      } finally {
        showLoading(false);
      }
    }

    // --- Smart Media Loader ---
    const MediaLoader = {
      queue: [],
      processing: false,
      observer: null,
      loadedCount: 0,
      initialBatchSize: 15,

      init() {
        if (this.observer) return;
        this.observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const id = entry.target.dataset.id;
              if (id && !mediaCache.has(id)) {
                this.enqueue(id);
                this.observer.unobserve(entry.target);
              }
            }
          });
        }, { rootMargin: '200px' });
      },

      observe(el) {
        if (this.observer) this.observer.observe(el);
      },

      enqueue(id) {
        if (!this.queue.includes(id)) {
          this.queue.push(id);
          this.process();
        }
      },

      async process() {
        if (this.processing || this.queue.length === 0) return;
        this.processing = true;

        // Take chunk
        const chunkKeys = this.queue.splice(0, 10);
        await this.fetchChunk(chunkKeys);

        // Check loading state
        this.loadedCount += chunkKeys.length;
        const loadingOverlay = document.getElementById('loading');
        if (loadingOverlay && loadingOverlay.style.display !== 'none') {
          if (this.loadedCount >= this.initialBatchSize || (this.queue.length === 0 && this.loadedCount > 0)) {
            // Fade out
            loadingOverlay.style.opacity = '0';
            setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500);
          }
        }

        this.processing = false;
        if (this.queue.length > 0) this.process();
      },

      async fetchChunk(keys) {
        if (keys.length === 0) return;
        const filter = keys.map(k => `ListingKey eq '${k}'`).join(' or ');
        const url = `${API_BASE}/api/v2/OData/bsaor/Property`;
        const params = new URLSearchParams({
          $filter: filter,
          $select: 'ListingKey,Media'
        });

        try {
          const res = await fetch(`${url}?${params}`);
          if (res.ok) {
            const data = await res.json();
            const items = data.value || [];
            const foundItems = [];

            items.forEach(p => {
              if (p.Media && Array.isArray(p.Media) && p.Media.length > 0) {
                const sorted = p.Media.sort((a, b) => (a.Order || 0) - (b.Order || 0));
                // Cache FULL array of URLs
                const urls = sorted.map(m => m.MediaURL || m.MediaUrl || m.MediaURLLarge).filter(u => u);

                if (urls.length > 0) {
                  mediaCache.set(p.ListingKey, urls);
                  foundItems.push(p);
                }
              }
            });
            updateImagesInUI(foundItems);
          }
        } catch (e) {
          console.warn("MediaLoader error", e);
        }
      }
    };

    // --- Legacy Replacement ---
    async function fetchMediaBatch(listings) {
      // Initialize Loader
      MediaLoader.init();
      // We rely on IntersectionObserver now
    }

    async function fetchMediaForChunk(chunk) {
      // Deprecated: Logic moved to MediaLoader.Process
    }

    function updateImagesInUI(chunk) {
      // Find img elements for these keys and update src
      chunk.forEach(item => {
        const urls = mediaCache.get(item.ListingKey);
        if (urls && urls.length > 0) {
          const url = urls[0]; // Default to first

          // Update grid card
          const img = document.querySelector(`#img-${item.ListingKey}`);
          if (img) {
            img.src = url;
            // Update count logic if needed
            const countEl = document.getElementById(`count-${item.ListingKey}`);
            if (countEl) countEl.innerText = `1 / ${urls.length}`;
          }
          // Update featured carousel card
          const cImg = document.querySelector(`#c-img-${item.ListingKey}`);
          if (cImg) cImg.src = url;
          // Update status carousel card
          const sImg = document.querySelector(`#s-img-${item.ListingKey}`);
          if (sImg) sImg.src = url;
        }
      });
    }

    function renderCarousel(items) {
      const track = document.getElementById('carouselTrack');
      const container = document.getElementById('featuredCarousel');
      const wrapper = document.getElementById('carouselsWrapper');

      if (items.length === 0) {
        container.style.display = 'none';
        checkWrapperVisibility();
        return;
      }

      container.style.display = 'block';
      wrapper.style.display = 'block';
      track.innerHTML = '';

      items.forEach(item => {
        const price = formatter.format(item.ListPrice || 0);
        const el = document.createElement('div');
        el.className = 'carousel-card';
        // Add ID for observer and loading hook
        el.dataset.id = item.ListingKey;
        el.innerHTML = `
                <div class="carousel-img-wrapper">
                     <img src="https://via.placeholder.com/300x200?text=Loading..." id="c-img-${item.ListingKey}" class="carousel-img" loading="lazy">
                     <div class="price-badge">${price}</div>
                </div>
                <div class="card-content">
                    <div class="card-address" style="font-size:0.9rem;">${item.UnparsedAddress}</div>
                    <div class="card-meta">${item.City}</div>
                </div>
            `;
        el.onclick = () => {
          // Scroll to grid item and map
          const gridCard = document.getElementById(`card-${item.ListingKey}`);
          if (gridCard) {
            gridCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            gridCard.click(); // Triggers map flyTo
          }
        };
        track.appendChild(el);
        MediaLoader.observe(el);
      });
    }

    function renderStatusCarousel(items) {
      const track = document.getElementById('statusTrack');
      const container = document.getElementById('statusCarousel');
      const wrapper = document.getElementById('carouselsWrapper');

      if (items.length === 0) {
        container.style.display = 'none';
        checkWrapperVisibility();
        return;
      }

      container.style.display = 'block';
      wrapper.style.display = 'block';
      track.innerHTML = '';

      items.forEach(item => {
        const price = formatter.format(item.ListPrice || 0);
        const el = document.createElement('div');
        el.className = 'carousel-card';
        // Add ID for helper
        el.dataset.id = item.ListingKey;
        el.innerHTML = `
                <div class="carousel-img-wrapper">
                     <img src="https://via.placeholder.com/300x200?text=Loading..." id="s-img-${item.ListingKey}" class="carousel-img" loading="lazy">
                     <div class="price-badge">${price}</div>
                </div>
                <div class="card-content">
                    <div class="card-address" style="font-size:0.9rem;">${item.UnparsedAddress}</div>
                    <div class="card-meta">${item.City} (Updated)</div>
                </div>
            `;
        el.onclick = () => {
          const gridCard = document.getElementById(`card-${item.ListingKey}`);
          if (gridCard) {
            gridCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            gridCard.click();
          }
        };
        track.appendChild(el);
        MediaLoader.observe(el);
      });
    }

    function checkWrapperVisibility() {
      const c1 = document.getElementById('featuredCarousel');
      const c2 = document.getElementById('statusCarousel');
      const wrapper = document.getElementById('carouselsWrapper');
      if (c1.style.display === 'none' && c2.style.display === 'none') {
        wrapper.style.display = 'none';
      } else {
        wrapper.style.display = 'block';
      }
    }

    // --- Filter Logic ---
    function setupFilters() {
      const ids = ['sortFilter', 'cityFilter', 'priceMin', 'priceMax', 'bedsFilter'];
      const applyBtn = document.getElementById('applyFiltersBtn');
      const clearBtn = document.getElementById('clearFiltersBtn');

      applyBtn.addEventListener('click', apply);
      clearBtn.addEventListener('click', () => {
        ids.forEach(id => document.getElementById(id).value = "");
        apply();
      });

      // Allow immediate change on selects too? Maybe just button for complex filters
      document.getElementById('sortFilter').addEventListener('change', apply);
      document.getElementById('cityFilter').addEventListener('change', apply);

      function apply() {
        const sort = document.getElementById('sortFilter').value;
        const city = document.getElementById('cityFilter').value;
        const minP = Number(document.getElementById('priceMin').value) || 0;
        const maxP = Number(document.getElementById('priceMax').value) || Infinity;
        const beds = Number(document.getElementById('bedsFilter').value) || 0;

        let filtered = allListings.filter(item => {
          const price = item.ListPrice || 0;
          const b = item.BedroomsTotal || 0;

          if (city && item.City !== city) return false;
          if (price < minP) return false;
          if (price > maxP) return false;
          if (b < beds) return false;

          return true;
        });

        // Sort
        if (sort === 'priceDesc') {
          filtered.sort((a, b) => (b.ListPrice || 0) - (a.ListPrice || 0));
        } else if (sort === 'priceAsc') {
          filtered.sort((a, b) => (a.ListPrice || 0) - (b.ListPrice || 0));
        } else {
          // Date desc (default in fetch but good to re-enforce)
          filtered.sort((a, b) => (b.ListingContractDate || "") > (a.ListingContractDate || "") ? 1 : -1);
        }

        updateUI(filtered);
      }
    }

    function updateUI(listings) {
      const grid = document.getElementById('listingsGrid');
      const count = document.getElementById('resultsCount');

      grid.innerHTML = '';
      count.innerText = `${listings.length} Properties found`;

      listings.forEach(item => {
        const card = document.createElement('div');
        card.className = 'listing-card';
        card.id = `card-${item.ListingKey}`;

        // Get MEDIA from Cache (Array or single)
        const cachedMedia = mediaCache.get(item.ListingKey);
        let imgUrl = 'https://via.placeholder.com/400x300?text=No+Photo';
        let photoCount = 0;

        if (cachedMedia && Array.isArray(cachedMedia) && cachedMedia.length > 0) {
          imgUrl = cachedMedia[0];
          photoCount = cachedMedia.length;
        } else if (cachedMedia && typeof cachedMedia === 'string') {
          imgUrl = cachedMedia;
          photoCount = 1;
        }

        const price = formatter.format(item.ListPrice || 0);

        card.innerHTML = `
            <div class="card-img-wrapper">
                <img src="${imgUrl}" id="img-${item.ListingKey}" class="card-img" alt="${item.UnparsedAddress}" loading="lazy" data-index="0">
                <div class="price-badge">${price}</div>
                
                <!-- Carousel Controls -->
                <button class="card-arrow left" onclick="changeCardImage(event, '${item.ListingKey}', -1)">&#10094;</button>
                <button class="card-arrow right" onclick="changeCardImage(event, '${item.ListingKey}', 1)">&#10095;</button>
                <div class="photo-count" id="count-${item.ListingKey}">1 / ${Math.max(1, photoCount)}</div>
            </div>
            <div class="card-content">
                <div class="card-address">${item.UnparsedAddress || 'Unknown Address'}</div>
                <div class="card-details">
                    <span class="card-detail-item"><i class="fas fa-bed"></i> ${item.BedroomsTotal || 0}</span>
                    <span class="card-detail-item"><i class="fas fa-bath"></i> ${item.BathroomsTotalInteger || 0}</span>
                    <span class="card-detail-item"><i class="fas fa-ruler-combined"></i> ${item.LivingArea || 0} sqft</span>
                </div>
                <div class="card-meta">
                    <span>${item.City || ''}</span>
                    <button class="search-btn" style="padding: 4px 10px; font-size: 0.8rem;">Details</button>
                </div>
            </div>
        `;

        card.appendChild(mediaLoaderHook(item)); // Optional hidden hook if needed, but we observe card directly

        // Add ID for observer
        card.dataset.id = item.ListingKey;

        // Interactive hovers
        card.addEventListener('mouseenter', () => highlightMarker(item.ListingKey, true));
        card.addEventListener('mouseleave', () => highlightMarker(item.ListingKey, false));
        card.addEventListener('click', () => {
          // Pan map
          let lat, lng;
          if (item.Coordinates && Array.isArray(item.Coordinates) && item.Coordinates.length === 2) {
            lng = item.Coordinates[0];
            lat = item.Coordinates[1];
          }

          if (lat && lng) {
            map.flyTo([lat, lng], 16);
            highlightMarker(item.ListingKey, true);
          }
        });

        grid.appendChild(card);
        MediaLoader.observe(card);
      });

      renderMapMarkers(listings);
    }

    // --- Carousel Logic ---
    function changeCardImage(event, key, direction) {
      event.stopPropagation(); // Stop card click
      event.preventDefault();

      const urls = mediaCache.get(key);
      if (!urls || !Array.isArray(urls) || urls.length === 0) return;

      const img = document.getElementById(`img-${key}`);
      const countEl = document.getElementById(`count-${key}`);
      if (!img) return;

      let idx = parseInt(img.dataset.index || '0');
      idx += direction;

      // Wrap
      if (idx < 0) idx = urls.length - 1;
      if (idx >= urls.length) idx = 0;

      img.src = urls[idx];
      img.dataset.index = idx;

      if (countEl) countEl.innerText = `${idx + 1} / ${urls.length}`;
    }

    // --- Styles for Price Pins & Carousel ---
    // Creating dynamic styles for pins
    // We need to define .price-pin in CSS above, let's do it via JS or assume it's added to style block

    function mediaLoaderHook(item) {
      // No-op for now, was placeholder for future logic
      return document.createDocumentFragment();
    }

    function renderMapMarkers(listings) {
      // Clear existing
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      listings.forEach(item => {
        // Parse Coordinates: [long, lat]
        let lat, lng;
        if (item.Coordinates && Array.isArray(item.Coordinates) && item.Coordinates.length === 2) {
          lng = item.Coordinates[0];
          lat = item.Coordinates[1];
        }

        if (lat && lng) {
          const priceShort = formatPriceShort(item.ListPrice || 0);

          // Use DivIcon for price label
          const icon = L.divIcon({
            className: 'price-pin-container',
            html: `<div class="price-pin">${priceShort}</div>`,
            iconSize: [50, 24],
            iconAnchor: [25, 12]
          });

          const mk = L.marker([lat, lng], { icon: icon })
            .bindPopup(`<b>${formatter.format(item.ListPrice)}</b><br>${item.UnparsedAddress}`);

          mk.listingKey = item.ListingKey;
          mk.on('click', () => {
            const card = document.getElementById(`card-${item.ListingKey}`);
            if (card) {
              card.scrollIntoView({ behavior: 'smooth', block: 'center' });
              card.classList.add('active');
              setTimeout(() => card.classList.remove('active'), 2000);
            }
          });

          mk.addTo(map);
          markers.push(mk);
        }
      });

      // Fit bounds
      if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
      }
    }

    function highlightMarker(key, active) {
      const mk = markers.find(m => m.listingKey === key);
      if (mk) {
        const el = mk.getElement(); // Get the divIcon element
        if (el) {
          const pin = el.querySelector('.price-pin');
          if (pin) {
            if (active) {
              pin.style.background = '#4bc6f6';
              pin.style.color = '#fff';
              pin.style.transform = 'scale(1.1)';
              pin.style.zIndex = '1000';
              mk.openPopup();
            } else {
              pin.style.background = '';
              pin.style.color = '';
              pin.style.transform = '';
              pin.style.zIndex = '';
              mk.closePopup();
            }
          }
        }
      }
    }

    function formatPriceShort(price) {
      if (price >= 1000000) return '$' + (price / 1000000).toFixed(1) + 'm';
      if (price >= 1000) return '$' + (price / 1000).toFixed(0) + 'k';
      return '$' + price;
    }

    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'flex' : 'none';
    }

  </script>

  <!-- FINAL CSS OVERRIDE TO FIX ELEMENTOR LOGO ISSUE -->
  <style>
    /* New Styles for Carousel & Pins */
    .carousels-wrapper {
      width: 100%;
      background: #fff;
      border-bottom: 1px solid #eee;
      /* margin-top is inline in HTML */
    }

    .carousel-container {
      width: 100%;
      background: #fff;
      padding-left: 0;
    }

    .carousel-header {
      padding: 0 20px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }

    .carousel-header h2 {
      font-size: 1.1rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #333;
    }

    .badge-new {
      background: #4bc6f6;
      color: #fff;
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 12px;
      text-transform: uppercase;
      font-weight: 700;
      vertical-align: middle;
    }

    .badge-update {
      background: #9f7aea;
      /* Purple for updates */
      color: #fff;
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 12px;
      text-transform: uppercase;
      font-weight: 700;
    }

    /* Adjust main container since carousel pushes it down */
    .main-container {
      padding-top: 0 !important;
      /* Remove padding since carousel takes space */
      height: calc(100vh - 450px);
      /* Adjust height for double carousel */
      min-height: 400px;
    }

    .carousel-track {
      display: flex;
      gap: 15px;
      overflow-x: auto;
      padding: 0 20px 20px 20px;
      scroll-behavior: smooth;
    }

    .carousel-card {
      flex: 0 0 240px;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .carousel-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .carousel-img-wrapper {
      position: relative;
      height: 140px;
      background: #eee;
    }

    .carousel-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Carousel Controls in Card */
    .card-img-wrapper {
      position: relative;
    }

    .card-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      cursor: pointer;
      padding: 8px 12px;
      font-size: 18px;
      z-index: 10;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card-img-wrapper:hover .card-arrow {
      opacity: 1;
    }

    .card-arrow.left {
      left: 5px;
    }

    .card-arrow.right {
      right: 5px;
    }

    .card-arrow:hover {
      background: rgba(0, 0, 0, 0.8);
    }

    .photo-count {
      position: absolute;
      bottom: 5px;
      right: 5px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      z-index: 5;
    }

    /* Price Pin Styles */
    .price-pin {
      background: #fff;
      color: #333;
      padding: 2px 6px;
      border-radius: 12px;
      font-weight: bold;
      font-size: 11px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      text-align: center;
      border: 1px solid #ccc;
      white-space: nowrap;
      display: inline-block;
      transition: all 0.2s;
    }

    /* Force override of ANY theme or builder styles */
    html body .ber-logo,
    html body img.ber-logo,
    html body .brand-wrapper img,
    html body .elementor img.ber-logo {
      width: auto !important;
      height: 50px !important;
      /* Fixed height is safest */
      max-width: 200px !important;
      min-width: unset !important;
      object-fit: contain !important;
      border: none !important;
      box-shadow: none !important;
      margin: 0 !important;
      display: block !important;
    }

    /* Reset Elementor's global image sizing if it targets generic imgs */
    html body .elementor-widget-image img {
      /* Only reset if it's our logo or causing issues */
      /* checks if this is inside our header */
    }

    /* Ensure header container doesn't explode */
    html body #top-bar {
      max-height: 80px !important;
      overflow: hidden !important;
      /* Clipped if something goes wrong */
    }
  </style>
</body>

</html>